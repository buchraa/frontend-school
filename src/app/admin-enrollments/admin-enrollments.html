<div class="space-y-6">

  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
    <div>
      <h1 class="text-xl font-semibold text-gray-900">
        Demandes d’inscription
      </h1>
      <p class="text-xs text-gray-500">
        Rentrée en cours : gestion des nouvelles inscriptions et réinscriptions.
      </p>
    </div>

    <div class="flex flex-wrap gap-2 text-xs">
      <select
        [(ngModel)]="statusFilter"
        (change)="load()"
        class="border rounded px-2 py-1 bg-white"
      >
        <option value="ALL">Tous les statuts</option>
        <option value="SUBMITTED">Soumises</option>
        <option value="UNDER_REVIEW">En cours d’étude</option>
        <option value="PENDING_TEST">En attente de test</option>
        <option value="VALIDATED">Validées</option>
        <option value="REJECTED">Refusées</option>
      </select>

      <input
        [(ngModel)]="search"
        placeholder="Recherche famille / code"
        class="border rounded px-2 py-1 bg-white"
      />
    </div>
  </div>

  <div *ngIf="loading" class="text-sm text-gray-500">
    Chargement des demandes...
  </div>

  <div *ngIf="error" class="text-sm text-red-600">
    {{ error }}
  </div>

  <div *ngIf="!loading && !filteredRequests.length" class="text-sm text-gray-500">
    Aucune demande pour ce filtre.
  </div>

  <div *ngIf="!loading && filteredRequests.length" class="bg-white rounded shadow overflow-hidden">
    <table class="min-w-full text-xs">
      <thead class="bg-gray-50 border-b">
        <tr>
          <th class="px-3 py-2 text-left">Famille</th>
          <th class="px-3 py-2 text-left">Code</th>
          <th class="px-3 py-2 text-left">Année</th>
          <th class="px-3 py-2 text-left">Enfants</th>
          <th class="px-3 py-2 text-left">Statut</th>
          <th class="px-3 py-2 text-left">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let r of filteredRequests"
          class="border-b hover:bg-gray-50"
        >
          <td class="px-3 py-2">
            {{ r.familyName || '—' }}
          </td>
          <td class="px-3 py-2">
            {{ r.familyCode || '—' }}
          </td>
          <td class="px-3 py-2">
            {{ r.schoolYear?.label || '—' }}
          </td>
          <td class="px-3 py-2">
            {{ r.childrenCount || 0 }}
          </td>
          <td class="px-3 py-2">
            <span
              class="px-2 py-1 rounded-full text-[0.7rem] font-medium"
              [ngClass]="{
                'bg-yellow-100 text-yellow-800': r.status === 'SUBMITTED',
                'bg-blue-100 text-blue-800': r.status === 'UNDER_REVIEW',
                'bg-purple-100 text-purple-800': r.status === 'PENDING_TEST',
                'bg-green-100 text-green-800': r.status === 'VALIDATED',
                'bg-red-100 text-red-800': r.status === 'REJECTED'
              }"
            >
              {{ r.status }}
            </span>
          </td>
          <td class="px-3 py-2">
            <div class="flex flex-wrap gap-1">
                              <a [routerLink]="['/admin/enrollment',r.id]" class="text-indigo-600 hover:underline">Gérer</a>

              <button
                class="px-2 py-1 rounded bg-gray-200 text-gray-800"
                type="button"
                (click)="setStatus(r, 'UNDER_REVIEW')"
                [disabled]="savingId === r.id"
              >
                Étudier
              </button>
              <button
                class="px-2 py-1 rounded bg-purple-200 text-purple-800"
                type="button"
                (click)="setStatus(r, 'PENDING_TEST')"
                [disabled]="savingId === r.id"
              >
                Test
              </button>
              <button
                class="px-2 py-1 rounded bg-green-200 text-green-800"
                type="button"
                (click)="setStatus(r, 'VALIDATED')"
                [disabled]="savingId === r.id"
              >
                Valider
              </button>
              <button
                class="px-2 py-1 rounded bg-red-200 text-red-800"
                type="button"
                (click)="setStatus(r, 'REJECTED')"
                [disabled]="savingId === r.id"
              >
                Refuser
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
