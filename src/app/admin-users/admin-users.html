<div class="space-y-6" *ngIf="vm$ | async as vm">

  <!-- Header -->
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold">Gestion des utilisateurs</h1>
      <p class="text-sm text-gray-500">Tous les comptes.</p>
    </div>

    <button
      class="px-3 py-2 rounded bg-indigo-600 text-white text-sm"
      (click)="openCreate()"
    >
      + Créer utilisateur
    </button>
  </div>

  <!-- Filters -->
  <div class="flex gap-3">
    <input
      [(ngModel)]="search"
      placeholder="Rechercher..."
      class="border rounded px-3 py-2 text-sm w-80"
    />

    <select
      [(ngModel)]="roleFilter"
      class="border rounded px-3 py-2 text-sm"
    >
      <option value="ALL">Tous</option>
      <option value="ADMIN">ADMIN</option>
      <option value="STAFF">STAFF</option>
      <option value="TEACHER">TEACHER</option>
      <option value="PARENT">PARENT</option>
      <option value="BENEVOL">BENEVOL</option>
    </select>

    <button
      class="px-3 py-2 rounded bg-gray-200 text-sm"
      (click)="refresh()"
    >
      Rafraîchir
    </button>
  </div>

  <!-- States -->
  @if (vm.usersState.loading) {
    <div class="text-sm text-gray-500">Chargement…</div>
  }

  @if (vm.usersState.error) {
    <div class="text-sm text-red-600">
      {{ vm.usersState.error }}
    </div>
  }

  <!-- Table -->
  @if (!vm.usersState.loading && !vm.usersState.error) {
    <div class="bg-white rounded shadow">
      <table class="w-full text-sm">
        <thead class="bg-gray-50">
          <tr>
            <th class="p-3 text-left">Nom</th>
            <th class="p-3 text-left">Email</th>
            <th class="p-3">Rôle</th>
            <th class="p-3 text-right">Actions</th>
          </tr>
        </thead>

        <tbody>
          @for (u of vm.filteredUsers; track u.id) {
            <tr class="border-t">
              <td class="p-3">{{ u.fullName || '—' }}</td>
              <td class="p-3">{{ u.email }}</td>
              <td class="p-3 text-center">
                <span
                  class="px-2 py-1 rounded-full text-xs"
                  [ngClass]="badgeClass(u.role)"
                >
                  {{ u.role }}
                </span>
              </td>
              <td class="p-3 text-right space-x-2">
                <a
                  *ngIf="goToProfile(u) as link"
                  [routerLink]="link"
                  class="px-2 py-1 bg-gray-200 rounded text-xs"
                >
                  Profil
                </a>
                <button
                  class="px-2 py-1 bg-red-600 text-white rounded text-xs"
                  (click)="removeUser(u)"
                >
                  Supprimer
                </button>
              </td>
            </tr>
          }

          @if (!vm.filteredUsers.length) {
            <tr>
              <td colspan="4" class="p-6 text-center text-gray-500">
                Aucun utilisateur trouvé.
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>
